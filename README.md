# Calibration-Camera-UI
UI для внешней и внутренней калибровки камеры различными методами. Получение матриц трансформации

## Теория

***

### Внутренняя калибровка камеры 
Внутренняя калибровка представляет собой процедуру определения внутренних параметров камеры, которые описывают оптические свойства устройства. Главными элементами данной калибровки являются фокусные расстояния, координаты главной точки, коэффициент сдвига (skew) и параметры искажений объектива (радиальные и тангенциальные). 
Классической моделью камеры служит модель, в рамках которой процесс проекции точек из трёхмерного пространства на плоскость изображения описывается матрицей внутренних параметров K

![Матрица внутренних параметров](https://github.com/user-attachments/assets/f7544646-8436-4ea5-a256-1067f76e0b41)


где Fx​ и Fy​ – фокусные расстояния по горизонтали и вертикали соответственно, Cx​ и Cy​ – координаты главной точки, а  представляет коэффициент сдвига, учитывающий неортогональность осей пикселей. Помимо этих параметров, на точность модели существенно влияют нелинейные искажения, в частности радиальные, описываемые, например, полиномом второго и третьего порядка, и тангенциальные, отражающие асимметричность оптической системы.

Одним из широко известных подходов для внутренней калибровки является метод, который позволяет оценить параметры камеры на основе набора изображений плоского калибровочного шаблона, чаще всего шахматной доски известного размера, захваченной с различными ориентациями.

![Доска калибровки Charuco](https://github.com/user-attachments/assets/e429ebf1-3137-4776-9c4d-bac99d47e323)

Методика включает несколько этапов.
  - Вычисление гомографий между плоским шаблоном и изображениями.
  - Определение начальных оценок внутренних параметров посредством линейных методов.
  - Итеративное уточнение параметров с использованием нелинейной оптимизации (например, методом наименьших квадратов) для минимизации ошибки проекции.

***

### Внешняя калибровка камеры 

Внешняя калибровка представляет собой процедуру определения параметров, описывающих положение и ориентацию камеры в мировой системе координат. В отличие от внутренней калибровки, которая фокусируется на характеристиках оптической системы и геометрии сенсора, внешняя калибровка направлена на установление взаимосвязи между координатами объектов в пространстве и их изображениями на плоскости.
Основная задача внешней калибровки состоит в вычислении матрицы поворота R и вектора трансляции t. Эти параметры позволяют перейти от системы координат мира к системе координат камеры посредством следующего уравнения проекции:

![изображение](https://github.com/user-attachments/assets/5fb0cfb4-7b40-4ede-ba11-81a1c2378fcb)

где:
  - x – вектор однородных координат точки на изображении,
  - K – матрица внутренних параметров камеры,
  - R – матрица поворота (свойство ортогональности ![изображение](https://github.com/user-attachments/assets/09300cac-9e5d-42b5-911a-8bd36063b372) и ![изображение](https://github.com/user-attachments/assets/fa69c8e0-d685-46de-a0c0-557663c7c313) ,
  - t – вектор трансляции,
  - X – вектор однородных координат точки в мировой системе координат.

С математической точки зрения, задача внешней калибровки сводится к поиску такой пары R и t, которая минимизирует ошибку между наблюдаемыми координатами точек на изображении и их предсказанными значениями на основе модели проекции. Обычно эта задача формулируется в виде задачи наименьших квадратов:

![изображение](https://github.com/user-attachments/assets/6e3821ed-549e-4342-a060-95eba64789c2)

где Pi обозначает нелинейную функцию проекции. Для решения данной задачи часто применяются методы нелинейной оптимизации, например, алгоритм Левенберга–Марквардта, позволяющие итеративно уточнять значения R и t до достижения сходимости.

Активные маркеры, такие как ArUco или AprilTag, представляют собой специально разработанные шаблоны с уникальными идентификаторами, позволяющие однозначно определить их положение и ориентацию на изображении. Использование таких маркеров упрощает процесс калибровки, особенно в автоматизированных системах. 

![изображение](https://github.com/user-attachments/assets/77d917fc-c700-497f-ab4a-6855d792864f)

Процедура калибровки с активными маркерами включает:
  - Размещение маркеров в поле зрения камеры. ​
  - Автоматическое обнаружение и идентификация маркеров на изображениях. ​
  - Расчёт внутренних параметров камеры на основе известных размеров и расположения маркеров. 

## О проекте
Разработанное приложение представляет собой программное решение, реализующее весь спектр методов калибровки камер, включая внутреннюю, внешнюю, монокалибровку. Программный продукт разработан на языке C++ с использованием библиотеки OpenCV для обработки изображений и фреймворка Qt для построения графического интерфейса. В его функционал входят следующие возможности.
  - Настройка видеопотока.
  - Внутренняя калибровка камеры.
  - Внешняя калибровка камеры.

***

### Настройка видеопотока 
Окно настройки позволяет осуществить захват и предобработку видео. Программа поддерживает работу с видеопотоками и статическими изображениями. Реализована возможность получения видеопотока с камеры, из файловой системы ПК или через UDP по выбранному порту.

![изображение](https://github.com/user-attachments/assets/d82ef903-dabe-4492-af82-a10342b14bb2)

Окна настроки источника видеопотока (камера и UDP)

![изображение](https://github.com/user-attachments/assets/94df0414-6db1-404e-ba8d-2ed04e7be018)![изображение](https://github.com/user-attachments/assets/c75c6dc9-7fdb-4683-a94e-a2d9b800561d)

Дополнительно предусмотрена функциональность для динамического изменения таких параметров изображения, как масштаб, яркость, контрастность и другие корректирующие настройки, что позволяет адаптировать входные данные к требованиям последующей калибровки в режиме реального времени.

***

### Проведение внутренней калибровки.
Данная вкладка приложения отвечает за проведение внутренней калибровки камеры. Ниже представлено краткое представление возможностей данного раздела программы.

![изображение](https://github.com/user-attachments/assets/1177607f-7b37-422b-aa5b-93eda787b3b1)

Создание файла в PNG формате Charuco доски с заданными параметрами, определяющими размеры доски (количество квадратов по горизонтали и вертикали, длину стороны квадрата, а также длину стороны маркера) и идентификатор словаря маркеров ArUco. На основе этих параметров производится генерация экземпляра доски с применением библиотечных методов OpenCV. Картинка с калибровочной доской сохраняется по указанному пути. Так же в указанной директории появляется и YAML файл с параметрами сохранённой калибровочной доски. 

![изображение](https://github.com/user-attachments/assets/576eede9-b561-4174-a1c0-7b9f0f96f3dc)![изображение](https://github.com/user-attachments/assets/350a7c38-34ae-423e-a04d-90aa51dfeb96)

Во вкладке реализовано интерактивное и автоматизированное сохранение данных. Программный компонент поддерживает два режима захвата изображений: ручной и автоматический. Ручной режим инициируется пользователем посредством нажатия определённой клавиши, что позволяет сохранять только те кадры, на которых корректно обнаружена доска. В автоматическом режиме производится периодическая проверка и сохранение изображений через заданные интервалы времени при условии обнаружения достаточного количества углов. Все собранные изображения автоматически добавляются в базу данных для последующей калибровки.

![изображение](https://github.com/user-attachments/assets/9006bfed-8833-42ba-a0f2-dda26d0b755e)

На основании предварительно собранных данных (наборов координат углов и соответствующих идентификаторов) производится процедура калибровки. В процессе вычисления используется алгоритм, реализованный в библиотеке OpenCV, который позволяет оценить внутреннюю матрицу камеры, коэффициенты искажений, а также векторы поворота и трансляции для каждого изображения. Калибровка оценивается с использованием значения RMS ошибки: параметрическая оценка позволяет определить, достигнут ли требуемый уровень точности.
По завершении процедуры калибровки результаты (внутренняя матрица камеры и коэффициенты искажений) могут быть сохранены в файле в форматах YAML.

![изображение](https://github.com/user-attachments/assets/6a325b07-cf60-46de-86c0-816cfa96c49b)


***

###Проведение внешней калибровки.
Основная цель раздела заключается в автоматизированном распознавании маркеров ArUco, получении координат их углов и визуализации результатов детекции на исходном изображении. Дополнительно, компонент обеспечивает возможность проведения базовой калибровки камеры на основе информации, извлечённой из обнаруженных маркеров.

![изображение](https://github.com/user-attachments/assets/8bc5efde-f7a0-4a8c-b7e2-aa70f9603d57)

Так же есть возможность создания и сохранения изображений маркеров выбранного словаря и размера.

![изображение](https://github.com/user-attachments/assets/44914853-b437-47cd-bb2c-0628f1a5a93f)

Метод реализует процедуру калибровки внутренней матрицы камеры, при условии, что на изображении обнаружено ровно четыре маркера. Ключевые этапы данного метода состоят из следующих этапов.
  * Формирование 3D-модели. 
Определяются трёхмерные координаты углов предполагаемого калибровочного шаблона. В данном случае используется квадратная модель, где координаты задаются относительно центра системы координат (сдвиг на половину длины стороны).
  * Извлечение 2D координат.
Для каждого обнаруженного маркера вычисляется центр, определяемый как среднее арифметическое всех углов. Полученные точки располагаются в массиве, что соответствует их положению на изображении.

![изображение](https://github.com/user-attachments/assets/764a0619-dbc0-41e4-872d-a6051633caf2)

  * Инициализация параметров камеры. 
Внутренняя матрица камеры и коэффициенты дисторсии инициализируются из YAML файла или заполняются начальными единичными значениями
  * Вызов функции калибровки. 
С использованием стандартной функции cv::calibrateCamera() вычисляются окончательные параметры калибровки, включая вектор поворота и трансляции, что позволяет получить соответствующие оценки с использованием заданных 3D–2D соответствий. Полученные значения сохраняются в YAML файл.

![изображение](https://github.com/user-attachments/assets/5a16d4be-a09d-443e-bff7-1622c5d7713a)

## Завпуск программы 

```
  mkdir build
  cd build
  cmake ../
  make -j${nproc}
  ./Calibration_ui
```
